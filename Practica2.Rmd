---
title: "Práctica 2"
author: "Juan Pasaret y David Reyes"

date: "2023-06-01"
output:
  html_document:
    toc: yes
    number_sections: yes
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning = FALSE, message = FALSE}
library(rminer)
library(pROC)
```

# Descripción del dataset

El dataset seleccionado para la práctica se denomina [**Heart Attack Analysis & Prediction Dataset**](https://www.kaggle.com/datasets/rashikrahmanpritom/heart-attack-analysis-prediction-dataset)**.**

Es un conjunto de datos de análisis y predición de ataques cardiados. Está diseñado para la práctica de análisis estadístico, ya que el número de muestras es muy pequeño. Y el objetivo es predecir las posibilidades de sufrir un ataque al corazón, teniendo en cuenta los datos proporcionado por el mismo.

El conjunto está formado por dos ficheros que contienen las siguientes variables.

-   **Age**: Edad del paciente

-   **Sex** : Sexo del paciente

-   **exang**: angina inducida por el ejercicio (1 = sí; 0 = no)

-   **ca**: número de buques principales (0-3)

-   **cp** : Tipo de dolor torácico

    -   Valor 1: typical angina (angina típica)

    -   Valor 2: atypical angina (angina atípica)

    -   Valor 3: no-anginal pain (dolor no anginoso)

    -   Valor 4: asymptomatic (asintomático)

-   **trtbps**: presión arterial en reposo (en mm Hg)

-   **chol**: colesterol en mg/dl obtenido a través del sensor BMI

-   **fbs**: (azúcar en sangre en ayunas \> 120 mg/dl) (1 = verdadero; 0 = falso)

-   **rest_ecg** : resultados electrocardiográficos en reposo

    -   Valor 0: normal

    -   Valor 1: tener anomalías en la onda ST-T (inversiones de la onda T y/o elevación o depresión del ST \> 0,05 mV)

    -   Valor 2: mostrar hipertrofia ventricular izquierda probable o definitiva según los criterios de Estes

-   **thalach**: frecuencia cardíaca máxima alcanzada

-   **target**:

    -   0= menos posibilidades de ataque al corazón

    -   1= más posibilidades de ataque al corazón

# Integración y selección de los datos de interés a analizar

## Análisis exploratorio

El primer paso para realizar un análisis exploratorio es cargar el fichero de datos.

```{r}
# carga de datos
heart <- read.csv(file = 'heart.csv')

```

### Exploración del conjunto de datos

Verificamos la estructura del juego de datos principal. Vemos el número de columnas que tenemos y ejemplos de los contenidos de las filas.

```{r}
structure = str(heart)
```

Vemos que tenemos **14** variables y **303**registros.

A continuación vemos una muestra:

```{r}
head(heart, 10)
```

La descripción de las variables ha sido realizada por la autora en [la documentación de kaggle](#https://www.kaggle.com/datasets/rashikrahmanpritom/heart-attack-analysis-prediction-dataset/discussion/329925)

Factorización de variables categóricas. La variable ¨sex¨ se desconoce cómo está codificada:

```{r}
heart$sex<-as.factor(heart$sex)

heart$exng<-as.factor(heart$exng)
levels(heart$exng)<-c("No","Yes")

heart$cp<-as.factor(heart$cp)
levels(heart$cp)<-c("Tipical angina","Atypical angina","Non-anginal pain","Asymptomatic")

heart$fbs<-as.factor(heart$fbs)
levels(heart$fbs)<-c("False","True")

heart$restecg<-as.factor(heart$restecg)
levels(heart$restecg)<-c("Normal","ST-T wave abnormality","Left ventricular hypertrophy")

heart$slp<-as.factor(heart$slp)
levels(heart$slp)<-c("unsloping","flat","downsloping")

heart$thall<-as.factor(heart$thall)
levels(heart$thall)<-c("null","fixed defect","normal","reversable defect")
```

Se factoriza igualmente la variable output, que se utilizará para evaluar la precisión de nuestro modelo:

```{r}
#Output es la variable que vamos a utilizar para comparar si nuestro
heart$output<-as.factor(heart$output)
levels(heart$output)<-c("Less chance","More chance")

```

https://www.analyticsvidhya.com/blog/2021/05/classification-algorithms-in-python-heart-attack-prediction-and-analysis/

```{r echo=TRUE, message=FALSE, warning=FALSE}
require(ggplot2)
if (!require('GGally')) install.packages('GGally')
library(GGally)

ggpairs(heart, columns = 1:14)

ggpairs(heart, columns = 1:14, aes(color = output, alpha = 0.5))
```

# Limpieza de datos

## 
Se comprueba que no hay ninguna columna vacía

```{r}
print(sum(is.na(heart)))
```

Se observa que hay duplicado:
```{r}
sum(duplicated(heart))
```
Se quita el duplicado:
```{r}
heart<-heart[!duplicated(heart),]
```

# Identificación y gestión de valores extremos

Se identifican valores extremos en variables númericas

```{r}
numericas<-c("age","trtbps","chol","thalachh","oldpeak")

for (columnName in numericas) {
  meanColumn<-mean(heart[[columnName]])
  sdColumn<-sd(heart[[columnName]])
  lower<-meanColumn-sdColumn*2.5
  higher<-meanColumn+sdColumn*2.5
  outliers_lower<-length(which(heart[[columnName]]<lower))
  outliers_higher<-length(which(heart[[columnName]]>higher))
  if (outliers_higher | outliers_higher){
    cat("Outliers detectados en",
        columnName,
        ": ",
        sum(outliers_lower,outliers_higher),"\n")
  }
}


```


# Creción de conjunto training y test
```{r}
set.seed(9)
h<-holdout(heart$output,ratio=0.8)
heartTraining<-heart[h$tr,]
heartTest<-heart[h$ts,]
```


# Construcción de modelo
```{r}
Modelo=glm(formula=output~sex+age,
           data=heartTraining,
           family=binomial)

summary(Modelo)
```
# Evaluación del modelo

```{r}
output_predicted <- predict(Modelo,newdata=heartTest,type='response')

#Se asume que la predicción del modelo es 1 si el modelo de regresión logística es 0.8 o mayor.
output_predicted <- ifelse(output_predicted > 0.8,1,0)

matrix_confusion<-table(output_predicted,heartTest$output)
matrix_confusion
```
# Evaluación de la potencia

```{r}
test_roc = roc(heartTest$output~output_predicted, plot = TRUE, print.auc = TRUE)

auc(test_roc)
```

